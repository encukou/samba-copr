From 3660325482a661a5d198f2b13a77c61250c7f6ef Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?G=C3=BCnther=20Deschner?= <gd@samba.org>
Date: Fri, 10 Jul 2015 09:44:40 +0200
Subject: [PATCH] s4-torture: don't build the lsa forest trust krb5 tests when
 building with MIT Kerberos.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

BUG: https://bugzilla.samba.org/show_bug.cgi?id=11411

Guenther

Signed-off-by: GÃ¼nther Deschner <gd@samba.org>
Reviewed-by: Andreas Schneider <asn@samba.org>
(cherry picked from commit 2443c34c91035778c36cc0eb4e51e9e922aeea1b)
---
 source4/torture/rpc/lsa.c | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/source4/torture/rpc/lsa.c b/source4/torture/rpc/lsa.c
index 95caebb..44cdbdc 100644
--- a/source4/torture/rpc/lsa.c
+++ b/source4/torture/rpc/lsa.c
@@ -2903,6 +2903,8 @@ static bool check_pw_with_ServerAuthenticate3(struct dcerpc_pipe *p,
 	return true;
 }
 
+#ifdef SAMBA4_USES_HEIMDAL
+
 /*
  * This function is set in torture_krb5_init_context as krb5
  * send_and_recv function.  This allows us to override what server the
@@ -4103,6 +4105,7 @@ static bool check_pw_with_krb5(struct torture_context *tctx,
 	TALLOC_FREE(ctx);
 	return true;
 }
+#endif
 
 static bool check_dom_trust_pw(struct dcerpc_pipe *p,
 			       struct torture_context *tctx,
@@ -4234,9 +4237,13 @@ static bool check_dom_trust_pw(struct dcerpc_pipe *p,
 				 "check_pw_with_ServerAuthenticate3");
 
 	if (trusted->trust_type != LSA_TRUST_TYPE_DOWNLEVEL) {
+#ifdef SAMBA4_USES_HEIMDAL
 		ok = check_pw_with_krb5(tctx, incoming_creds, trusted);
 		torture_assert_int_equal(tctx, ok, expected_result,
 					 "check_pw_with_krb5");
+#else
+		torture_comment(tctx, "skipping check_pw_with_krb5 for MIT Kerberos build");
+#endif
 	}
 
 	if (expected_result != true || next_password == NULL) {
@@ -4319,8 +4326,12 @@ static bool check_dom_trust_pw(struct dcerpc_pipe *p,
 	torture_assert(tctx, ok, "check_pw_with_ServerAuthenticate3 with changed password");
 
 	if (trusted->trust_type != LSA_TRUST_TYPE_DOWNLEVEL) {
+#if SAMBA4_USES_HEIMDAL
 		ok = check_pw_with_krb5(tctx, incoming_creds, trusted);
 		torture_assert(tctx, ok, "check_pw_with_krb5 with changed password");
+#else
+		torture_comment(tctx, "skipping check_pw_with_krb5 for MIT Kerberos build");
+#endif
 	}
 
 	TALLOC_FREE(p2);
-- 
2.5.0

